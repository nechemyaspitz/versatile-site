# v3.5.1 - Cache & Scroll Restoration Fixes

**Deploy Date:** October 9, 2025  
**Version:** 3.5.1

## 🎯 Issues Fixed

This version addresses **4 critical issues** with the smart caching system introduced in v3.5.0:

---

## ✅ Issue #1: Cache Expiration Strategy

### **Problem:**
Cache had a static 5-minute expiration, causing:
- Page refreshes to restore old data even after 5 minutes
- No distinction between page refresh vs back button navigation
- Users seeing stale data on refresh

### **Solution:**
Implemented **smart cache expiration** with different rules for different scenarios:

```javascript
// Detect page refresh vs navigation
const isPageRefresh = window.performance && 
  (performance.navigation?.type === 1 || 
   performance.getEntriesByType('navigation')[0]?.type === 'reload');

if (isPageRefresh) {
  // On refresh: only restore if <30 seconds old
  if (timeSinceCache > 30000) {
    // Fetch fresh data
  }
} else {
  // On navigation (back button): restore if <10 minutes old
  if (timeSinceCache > 600000) {
    // Fetch fresh data
  }
}
```

**Result:**
- ✅ **Page refresh:** Refetch if >30 seconds old
- ✅ **Back button:** Restore if <10 minutes old
- ✅ **Fresh data on refresh**, cached data on navigation

---

## ✅ Issue #2: Missing Pagination State (CRITICAL)

### **Problem:**
Session cache wasn't saving `hasMorePages` flag, causing:
- Infinite scroll to try fetching more items when all were already loaded
- HTTP 500 errors when scrolling to bottom
- Error popup: "Error loading products / HTTP 500: / Reload Page"

### **Solution:**
Added `hasMorePages` to session state:

```javascript
// Save pagination state
saveToSession() {
  const state = {
    allLoadedItems: this._allLoadedItems,
    totalItems: this.totalItems,
    hasMorePages: this.hasMorePages, // NEW!
    currentPage: this.currentPage,
    // ...
  };
}

// Restore pagination state
tryRestoreFromSession() {
  this.hasMorePages = state.hasMorePages !== undefined 
    ? state.hasMorePages 
    : true;
  
  console.log('📦 Restored state:', {
    items: this._allLoadedItems.length,
    totalItems: this.totalItems,
    hasMorePages: this.hasMorePages // Now tracked!
  });
}
```

**Result:**
- ✅ Infinite scroll knows when to stop
- ✅ No more 500 errors on scroll
- ✅ Smooth UX when all items are loaded

---

## ✅ Issue #3: Lenis Scroll Restoration

### **Problem:**
Scroll restoration to clicked product wasn't working:
- Product element not found
- Timing issues with DOM/images
- No visual feedback

### **Solution:**
Improved timing and method following the Lenis example pattern:

```javascript
// Better timing + forced Lenis resize before scroll
if (this._clickedProductId && window.lenis) {
  setTimeout(() => {
    // Force Lenis to recalculate FIRST
    window.lenis.resize();
    
    const productEl = document.querySelector(
      `[data-product-id="${this._clickedProductId}"]`
    );
    
    if (productEl) {
      console.log('🎯 Scrolling to clicked product:', this._clickedProductId);
      
      // Use Lenis scrollTo (like the anchor example)
      window.lenis.scrollTo(productEl, {
        duration: 1.2,
        offset: -100,
        easing: (x) => (x < 0.5 ? 8*x*x*x*x : 1 - Math.pow(-2*x+2, 4)/2)
      });
    } else {
      console.warn('⚠️ Product element not found');
    }
  }, 500); // Longer delay for images to load
}
```

**Changes:**
- ✅ Increased timeout from 100ms → 500ms
- ✅ Force `lenis.resize()` before scrolling
- ✅ Better error handling with console warnings
- ✅ Smooth 1.2s animation to clicked product

**Result:**
- ✅ Reliable scroll restoration
- ✅ Beautiful smooth animation
- ✅ Works even with slow-loading images

---

## ✅ Issue #4: Jittery Scroll

### **Problem:**
Scroll felt jittery on collections page because:
- Images loading changed page height
- Lenis wasn't being notified of height changes
- Especially bad during infinite scroll

### **Solution:**
**Aggressive Lenis resize strategy** at multiple points:

```javascript
// 1. Immediate resize after DOM append
renderItems(items) {
  this.productContainer.appendChild(fragment);
  
  if (window.lenis) {
    window.lenis.resize(); // Immediate
    setTimeout(() => window.lenis.resize(), 50);  // Quick follow-up
    setTimeout(() => window.lenis.resize(), 200); // Medium delay
  }
}

// 2. Resize on EVERY image load
waitForImagesToLoad() {
  const checkAllLoaded = () => {
    loadedCount++;
    
    // Resize on EVERY image (not just last one!)
    if (window.lenis) {
      window.lenis.resize();
    }
  };
  
  images.forEach((img) => {
    img.addEventListener('load', checkAllLoaded);
    img.addEventListener('error', checkAllLoaded);
  });
}

// 3. Extra aggressive on infinite scroll
appendItems(items) {
  this.productContainer.appendChild(fragment);
  
  if (window.lenis) {
    window.lenis.resize();
    setTimeout(() => window.lenis.resize(), 50);
    setTimeout(() => window.lenis.resize(), 200);
    setTimeout(() => window.lenis.resize(), 500); // Extra delay
  }
}
```

**Result:**
- ✅ Buttery smooth scroll on collections page
- ✅ No jitter during infinite scroll
- ✅ Responsive to image loading
- ✅ Consistent experience

---

## 📊 Testing Checklist

### **Test 1: Cache Expiration**
```
1. Go to collections page
2. Wait 1 minute
3. Refresh page
   ✅ Should show: "🔄 Page refresh + cache expired (>30s), fetching fresh data"
   ✅ Fresh API call made

4. Go to collections → product → back button (within 30s)
   ✅ Should show: "⬅️ Back button navigation, restoring from cache"
   ✅ No API call, instant restore
```

### **Test 2: Pagination State**
```
1. Go to collections (10 items load)
2. Scroll down → 10 more load (20 total)
3. If only 21 items exist, next scroll should load 1 item
4. Scroll to bottom
   ✅ NO error popup
   ✅ Console shows: "hasMorePages: false"
5. Navigate away and back
   ✅ All 21 items restore
   ✅ No fetch attempt on scroll
```

### **Test 3: Lenis Scroll Restoration**
```
1. Go to collections
2. Scroll down (load 20 items)
3. Click product #15
4. Hit back button
   ✅ Page restores all 20 items
   ✅ Smooth 1.2s scroll to product #15
   ✅ Console shows: "🎯 Scrolling to clicked product: /collections/product-15"
```

### **Test 4: Jittery Scroll**
```
1. Go to collections
2. Slowly scroll down
   ✅ Buttery smooth (no jitter)
3. Scroll to trigger infinite load
   ✅ New items appear smoothly
   ✅ Scroll continues smoothly (no jump)
4. Filter products
   ✅ New items render smoothly
```

---

## 🎨 Console Logs to Watch

### **Fresh Load:**
```
🔄 Page refresh + cache expired (>30s), fetching fresh data
```

### **Back Button (Recent):**
```
⬅️ Back button navigation, restoring from cache
📦 Restored state: { items: 20, totalItems: 21, hasMorePages: true, currentPage: 2 }
💾 Saved to session: { items: 20, totalItems: 21, hasMorePages: true, page: 2 }
🎯 Scrolling to clicked product: /collections/product-15
```

### **All Items Loaded:**
```
📦 Restored state: { items: 21, totalItems: 21, hasMorePages: false, currentPage: 3 }
```

### **Image Loading:**
```
📸 All images loaded, Lenis fully resized
```

---

## 🚀 Performance Impact

| Scenario | Before | After | Improvement |
|----------|--------|-------|-------------|
| **Refresh (old cache)** | Restored stale data | Fresh fetch | ✅ Fresh data |
| **Scroll all items** | 500 error | Stops correctly | ✅ No errors |
| **Back button scroll** | Broken | Smooth animation | ✅ Perfect UX |
| **Infinite scroll** | Jittery | Buttery smooth | ✅ No jitter |

---

## 🎯 Key Code Changes

### **Files Modified:**
- `src/pages/collections.js` (main changes)
  - `tryRestoreFromSession()` - Smart cache expiration
  - `saveToSession()` - Save `hasMorePages`
  - `renderItems()` - Aggressive Lenis resize
  - `appendItems()` - Extra aggressive Lenis resize
  - `waitForImagesToLoad()` - Resize on every image

- `src/main.js` - Version bump to 3.5.1

---

## 📝 Technical Notes

### **Cache Strategy:**
```javascript
Page Refresh:
  - Detect: performance.navigation.type === 1
  - Expiry: 30 seconds
  - Rationale: User expects fresh data

Back Button:
  - Detect: Not a page refresh
  - Expiry: 10 minutes
  - Rationale: User expects their session state
```

### **Pagination State:**
```javascript
Session Storage Structure:
{
  allLoadedItems: [...],    // ALL items across pages
  totalItems: 21,           // From API pagination
  hasMorePages: false,      // Prevents extra fetches
  currentPage: 3,           // Last page loaded
  clickedProductId: "..."   // For scroll restoration
}
```

### **Lenis Resize Strategy:**
- Immediate after DOM append
- Multiple timeouts (50ms, 200ms, 500ms)
- On every single image load
- Before scroll restoration

---

## ✅ All Issues Resolved

1. ✅ **Cache expiration:** Smart detection, different rules for refresh vs navigation
2. ✅ **Pagination state:** `hasMorePages` tracked, no more 500 errors
3. ✅ **Lenis scroll:** Better timing, forced resize, reliable restoration
4. ✅ **Jittery scroll:** Aggressive resize strategy, buttery smooth

**Status:** Deployed to production (v3.5.1)

